# 项目开发计划文档

**项目名称：基于以太坊的 NSW 土地使用权登记、续期与转移系统**

------

## 一、系统参与对象与职责建模

### 1. 用户（User）

- 是房产的合法所有人，绑定唯一以太坊钱包地址；
- 可通过前端界面授权代理人；
- 可查询自己名下房产状态和历史操作记录。

### 2. 代理人（Agent / Conveyancer）

- 接收用户授权后，作为代表操作区块链；
- 可登记房产、发起续期请求、产权转移；
- 系统验证其与用户的授权绑定关系。

### 3. 管理员（Admin）

- 拥有审批权限，模拟 NSW 土地登记处；
- 审批续期请求和产权转移请求；
- 审批信息上链，结果同步链下数据库。

### 4. 后端服务（System Backend）

- 提供 API 网关，对接前端和智能合约；
- 监听链上事件，更新链下 PostgreSQL；
- 管理用户/代理人绑定状态与操作记录。

### 5. 区块链智能合约

- `LandRegistry.sol`：管理房产登记与状态；
- `RenewalApproval.sol`：续期请求审批流程；
- `TransferApproval.sol`：产权转移请求与处理；
- 包含事件触发与角色权限控制。

### 6. 数据存储模块

- PostgreSQL：保存链下房产元数据、用户代理人关系、请求状态等；
- IPFS：存储房产材料、上传证明文件等；链上记录对应的CID。

------

## 二、各对象间交互逻辑与数据闭环说明

### 场景一：房产登记

1. 用户登录前端，授权代理人A；
2. 授权记录写入`authorized_agents`表；
3. 代理人A通过前端上传文件 → 返回CID；
4. 填写房产信息（folioNumber、owner）调用合约；
5. 合约中记录 owner 地址、folio、CID、到期时间；
6. 后端监听事件，写入 `properties` 表，状态设为“有效”。

### 场景二：续期申请

1. 用户授权代理人B；
2. 代理人B发起续期请求调用 `requestRenewal(folio)`；
3. 合约记录请求信息，触发 `RenewalRequested` 事件；
4. 管理员审核后通过 `approveRenewal(folio)`；
5. 合约更新到期时间，触发 `RenewalApproved`；
6. 后端监听更新数据库，状态改为“已续期”。

### 场景三：产权转移

1. 用户授权代理人C；
2. 代理人C发起 `requestTransfer(folio, newOwner)`；
3. 合约中记录申请，发出事件；
4. 管理员调用 `approveTransfer(folio)`，变更所有权；
5. 后端监听，记录转移历史到 `ownership_transfers` 表；
6. 前端展示新 owner 地址，完成闭环。

------

## 三、开发阶段与具体任务

### 阶段一：智能合约模块开发

| 任务编号 | 描述                                                         |
| -------- | ------------------------------------------------------------ |
| 1.1      | 编写 `LandRegistry.sol`，定义 `registerProperty()`、`getProperty()`、`transferOwner()` |
| 1.2      | 编写 `RenewalApproval.sol`，定义 `requestRenewal()`、`approveRenewal()` |
| 1.3      | 编写 `TransferApproval.sol`，定义 `requestTransfer()`、`approveTransfer()` |
| 1.4      | 使用 `AccessControl` 限制函数调用权限（代理人 / 管理员）     |
| 1.5      | 添加事件：`PropertyRegistered`、`RenewalRequested`、`RenewalApproved`、`TransferRequested`、`TransferApproved` |
| 1.6      | 本地 Hardhat 测试：角色控制、状态变化、边界异常              |
| 1.7      | 合约部署到 Goerli，记录地址、生成 ABI                        |

------

### 阶段二：后端服务开发（Node.js + PostgreSQL）

| 任务编号 | 描述                                                         |
| -------- | ------------------------------------------------------------ |
| 2.1      | 创建数据库表结构，包括 `properties`、`renewal_requests`、`ownership_transfers`、`agent_authorization` |
| 2.2      | 实现合约事件监听服务（Web3.js），同步数据库状态              |
| 2.3      | 实现用户授权代理人接口，使用钱包签名机制验证                 |
| 2.4      | 开发房产登记 API：校验代理人权限 → 合约调用                  |
| 2.5      | 开发续期请求 API：校验代理人身份 → 合约调用                  |
| 2.6      | 开发管理员审批续期接口：合约函数调用 → 更新状态              |
| 2.7      | 开发产权转移请求 + 审批流程接口                              |
| 2.8      | 查询接口：支持通过 folioNumber 获取房产状态与所有历史记录    |
| 2.9      | 实现每日定时任务，检测即将到期记录，自动更新提醒字段         |

------

### 阶段三：文件存储与 IPFS 接入

| 任务编号 | 描述                                            |
| -------- | ----------------------------------------------- |
| 3.1      | 配置 IPFS 连接（Infura 或本地节点）             |
| 3.2      | 编写前端上传模块，文件 → IPFS → 返回 CID        |
| 3.3      | 将 CID 传入 `registerProperty()` 并记录于数据库 |
| 3.4      | 支持基于 CID 预览房产材料内容（如PDF、图片等）  |

------

### 阶段四：前端交互与角色分视图开发

| 任务编号 | 描述                                                |
| -------- | --------------------------------------------------- |
| 4.1      | Metamask 登录识别用户身份（用户 / 代理人 / 管理员） |
| 4.2      | 用户界面：查看房产列表、授权代理人                  |
| 4.3      | 代理人界面：房产登记、续期、产权转移申请入口        |
| 4.4      | 管理员界面：审核续期与产权转移请求                  |
| 4.5      | 状态反馈展示：交易结果、合约事件信息、IPFS 文件链接 |
| 4.6      | 多角色钱包切换支持，模拟不同身份登录环境            |

------

### 阶段五：系统联调与演示准备

| 任务编号 | 描述                                               |
| -------- | -------------------------------------------------- |
| 5.1      | 全角色联调流程：用户授权 → 代理人操作 → 管理员审批 |
| 5.2      | 准备测试数据集与示例房产信息用于演示               |
| 5.3      | 测试每条合约路径是否触发正确事件并回写数据库       |
| 5.4      | 编写演示剧本：从授权到登记、续期、转移完整流程     |
| 5.5      | 编写部署说明（合约地址、启动命令、依赖项）         |
| 5.6      | 撰写最终 README、功能说明书、接口文档              |

------

## 四、数据完整性与交互闭环设计原则

- 所有合约事件必须有链下监听服务同步；
- 所有链下请求必须校验代理人授权关系；
- 所有合约调用必须严格角色权限控制；
- 所有链下数据必须与链上状态一致（定时比对）；
- 所有产权转移和审批过程都有日志可查，状态透明。

------

## 五、交付物与里程碑清单

- 智能合约代码（部署地址 + ABI）
- Node.js 服务代码与 PostgreSQL 脚本
- IPFS 接入模块
- HTML + JS 前端演示界面
- 完整测试数据与测试链交互记录
- 开发说明文档、接口文档、部署指南

------

